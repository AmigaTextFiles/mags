<HTML>
<HEAD>
<TITLE>
Проект Petunia
</TITLE>
<meta http-equiv="content-type" content="text/html; charset=windows-1251">
<BODY BACKGROUND="../GFX/fonm.gif">
</HEAD>
<CENTER>
<H2><IMG SRC="../GFX/edu.gif"><FONT COLOR="yellow"><b>Проект Petunia</b></FONT><IMG SRC="../GFX/edu.gif"></H2><BR>

<table border="1" cellpadding="4" cellspacing="0" width="80%" bordercolorlight="#5091F3" bordercolordark="#000000">
<tr bgcolor="black"><td align="left" background="../GFX/fon.gif">
<table border="0" width="100%"><tr bgcolor="black">
<td align="right"><FONT COLOR="green">Автор -=\AmiF1Team/=-</FONT></td>
</tr></table>
</td></tr>
<tr bgcolor="black">
<td background="../GFX/fon.gif">
<b><FONT COLOR="white"><FONT COLOR="yellow">Введение</FONT><BR><BR>
Что  ж,  наконец-то  мне  удалось  откопать  кое-какую  информацию по столь
засекреченному и скрываемому проекту Petunia - модулю, который будет включён
в   OS4.    Данный  модуль  предназначен  для  эмуляции  успевших  устареть
процессоров  серии Motorola 680x0.  Как вы сами понимаете, именно с помощью
данного   встроенного  модуля  владельцы  OS4  и  будут  способны  запускать
программное  обеспечение,  написанное  под  OS  3.x,  и  при этом динамически
перекомпилированный  код  под PPC будет исполняться намного быстрее.  То есть
работа  с  приложениями  680x0  на  самом слабом PPC будет намного быстрее,
нежели  на  самом  мощном 68060.  Динамическая перекомпиляция заключается в
переводе   команд   680x0  процессора  в  команды,  использующие  инструкции
специализированные для  PPC,  что по сути превращает код программы в родной
PPC  код, уже готовый для исполнения, то есть запускаемый файл.  В  настоящее
время  из  подобных проектов существует язык Java, который работает подобно
Petunia.<BR><BR>
Таким  образом можно смело переходить на Амиги нового поколения, построенные
на   базе  современных  PPC  процессоров;  модуль  гарантирует  "плавность"
перехода  не  только  на  новую  AmigaOS4, но и использование (посредством
данного модуля) любой из существующих программ под 680x0.<BR><BR>
<FONT COLOR="yellow">Особенности</FONT><BR><BR>
На  данный момент реализована высокоскоростная эмуляция процессора Motorola
68040,  но пока без поддержки MMU; её поддержка ожидается в скором будущем.
Уже  реализован  метод  эмуляции,  по  которому  процессор, как в оригинале,
реализует   одну  команду,  а  остальные  работают  на  прерываниях. В
последующей  версии,  которая  ожидается как раз перед официальным выходом
OS4, будет реализовано выполнение до 3 команд одновременно, что значительно
(порядка   нескольких   раз)   поднимет  скорость  виртуального  68040.
Фактически  это  означает,  что  каждый запрос системы (или чтение областей
памяти)  автоматически  подразумевает  реально  синхронный  доступ  задач к
процессору, что позволит не замедлять саму эмуляцию, а кроме того, выполнять
PPC-приложения без какого-то либо видимого торможения.<BR><BR>
Что же реально доступно в новейшей на сегодняшний день версии 0.39?<BR><BR>
Эмулирование кода:  полностью оптимизированный виртуальный 68040, кроме MMU;
всяческая  поддержка  математических  модулей FPU 68881/882/68040, исключая
FSAVE, FRESTORE.<BR>
Адресация:   вся  доступная  адресация  от  68020 и выше с реализацией всех
флагов  эмуляции,  то есть  при компилировании низкоуровневого флага поток
данных позволяет на лету оптимизировать компилируемый код.<BR><BR>
Также доступно контекстное переключение в AmigaOS и исправлено JSR d16(A6);
реализована   и   работа   WarpUP   приложений   с   двойными  контекстными
переключателями.   И  обязательный  контекстный  переключатель на каждый
некэшируемый поток данных, исходящий от системы, например, на чтение Execbase.<BR><BR>
Но  существуют пока ещё и нерешённые проблемы:  не реализованы регистры SFC
и  DFC,  а также не оптимизированы команды CALLM, RTM, CINV, CPUSH, PFLUSH,
PFLUSHA, PTEST.  Пока остаются не работоспособными программы, использующие
так  называемый не оптимизированный код, к счастью данная категория программ
не  очень большая.  Помимо этого сама программа написана не очень корректно,
что вызывает нестабильную работу оси, причиняя повреждения участкам памяти,
либо  самопроизвольно  изменяя  их.  Основной  проблемой  является
нереализованная  многопотоковость,  что  ограничивает  их число до одного, тем
самым  посылая  другие  задачи  на  прерывания,  не  используя асинхронного
доступа,  что  и  отражается на неработоспособности  большинства  игр  и демок.
Реализация  многопотоковости  повысит  скорость эмулятора порядка в 5-6 раз
минимум.<BR><BR>
Планы   на   будущее:    реализовать  полноценную  высокоскоростную  работу
виртуального 68040 процессора с MMU эмуляцией.<BR><BR>
Теперь,  я  бы  хотел  предоставить  вам тесты уже существующей в начальной
стадии   разработки   Petunia.    Стоит   учесть, что  фактические  числа  не
рассчитываются, а рассчитывается  только величина по сравнению друг с другом.
Собственно,  что  и  является  основным  показателем - продолжительность в
секундах, инициализация эмуляции.<BR><BR>

  <center>
    <table width="80%" border="0" cellpadding="4" cellspacing="0" style="border-collapse: collapse" bordercolor="#111111" id="AutoNumber1">
      <tr bgcolor="black">
        <td align="center">&nbsp;</td>
<TD  align="center" bgcolor="#C0C0C0"><FONT COLOR=yellow>
<b>040/25</b></font></TD>
<TD  align="center"><FONT COLOR=yellow>
<b>040/40</font></b></TD>
<TD  align="center" bgcolor="#C0C0C0"><FONT COLOR=yellow>
<b>060/50</font></b></TD>
<TD  align="center"><FONT COLOR=yellow>
<P><b>Petunia on<br>
603e/160</b></font></TD>
<TD  align="center" bgcolor="#C0C0C0"><FONT COLOR=yellow>
<P><b>Petunia on<br>
603/210</font></b></TD>
<TD  align="center"><FONT COLOR=yellow>
<b>Petunia on<br>
604/233</font></b></TD>
      </tr>
      <tr bgcolor="black">
        <td  align="center"><FONT COLOR=yellow><b>Mandel (secs)</b></font></td>
        <td  align="center" bgcolor="#C0C0C0"><FONT COLOR=white>35.17</font></td>
        <td  align="center"><FONT COLOR=white>21.44</font></td>
        <td  align="center" bgcolor="#C0C0C0"><FONT COLOR=white>5.24</font></td>
        <td  align="center"><FONT COLOR=white>6.9</font></td>
        <td  align="center" bgcolor="#C0C0C0"><FONT COLOR=white>5.78</font></td>
        <td  align="center"><FONT COLOR=white>3.37</font></td>
      </tr>
      <tr bgcolor="black">
        <td  align="center"><FONT COLOR=yellow><b>Julia FPU (secs)</font></b></td>
        <td  align="center" bgcolor="#C0C0C0"><FONT COLOR=white>92.51</font></td>
        <td  align="center"><FONT COLOR=white>-</td>
        <td  align="center" bgcolor="#C0C0C0"><FONT COLOR=white>23.39</font></td>
        <td  align="center"><FONT COLOR=white>21.66</font></td>
        <td  align="center" bgcolor="#C0C0C0"><FONT COLOR=white>18.04</font></td>
        <td  align="center"><FONT COLOR=white>14.27</font></td>
      </tr>
      <tr bgcolor="black">
        <td  align="center"><FONT COLOR=yellow><b>C2Ptest (secs)</b></font></td>
        <td  align="center" bgcolor="#C0C0C0"><FONT COLOR=white>31.33</font></td>
        <td  align="center"><FONT COLOR=white>30.47</font></td>
        <td  align="center" bgcolor="#C0C0C0"><FONT COLOR=white>13.17</font></td>
        <td  align="center"><FONT COLOR=white>21.42</font></td>
        <td  align="center" bgcolor="#C0C0C0"><FONT COLOR=white>11.93</font></td>
        <td  align="center"><FONT COLOR=white>13.32</font></td>
      </tr>
      <tr bgcolor="black">
        <td  align="center"><FONT COLOR=yellow><b>Demoeffect (FPS)</b></font></td>
        <td  align="center" bgcolor="#C0C0C0"><FONT COLOR=white>5.76</font></td>
        <td  align="center"><FONT COLOR=white>9.16</font></td>
        <td  align="center" bgcolor="#C0C0C0"><FONT COLOR=white>22.28</font></td>
        <td  align="center"><FONT COLOR=white>33.06</font></td>
        <td  align="center" bgcolor="#C0C0C0"><FONT COLOR=white>50.41*</font></td>
        <td  align="center"><FONT COLOR=white>49.57</font></td>
      </tr>
      <tr bgcolor="black">
        <td  align="center"><FONT COLOR=yellow><b>Voxelspace</font></b><FONT COLOR=yellow><b> (FPS)</b></font></td>
        <td  align="center" bgcolor="#C0C0C0"><FONT COLOR=white>13</font></td>
        <td  align="center"><FONT COLOR=white>17-18</font></td>
        <td  align="center" bgcolor="#C0C0C0"><FONT COLOR=white>23</font></td>
        <td  align="center"><FONT COLOR=white>16-18</font></td>
        <td  align="center" bgcolor="#C0C0C0"><FONT COLOR=white>20</font></td>
        <td  align="center"><FONT COLOR=white>30</font></td>
      </tr>
      <tr bgcolor="black">
        <td  align="center"><FONT COLOR=yellow><b>LZX packing (secs)</b></font></td>
        <td  align="center" bgcolor="#C0C0C0"><FONT COLOR=white>11.65</font></td>
        <td  align="center"><FONT COLOR=white>-</td>
        <td  align="center" bgcolor="#C0C0C0"><FONT COLOR=white>4.30</font></td>
        <td  align="center"><FONT COLOR=white>10.58</font></td>
        <td  align="center" bgcolor="#C0C0C0"><FONT COLOR=white>-</font></td>
        <td  align="center"><FONT COLOR=white>6.20</font></td>
      </tr>
    </table>
    </center>
<BR><BR>
* Тест прошёл с ошибкой в системе.<BR><BR>
Следует  учитывать,  что  тест  производился  на  ранней  версии, и что при
реализации  полноценного  68040  скорости  возрастут  в  3-4 раза от номинальной
производительности,  данное  повышение  ожидается  уже  в  следующей версии
Petunia.   Также  огромное  различие  тестов  между Voxelspace и Demoeffect
вызвано  проблемами  с  контекстными  переключателями; Demoeffect не делали
никаких  системных  запросов,  а Voxelspace не проверял бездействие системы
из-за  однопотоковости.   Так  что до официального выхода AmigaOS4 проект
Petunia должен  полноценно эмулировать 68040 со скоростью в 4-6 раз, большей
оригинала.<BR><BR>
Тесты производились в следующих программах:<UL>
<LI>Mandel  -  вычисление  500x200  пикселей  mandelbrot  и показ их в окне
WriteChunkyPixels;
<LI>Julia  FPU  -  копирование  области  памяти  640x480  с  использованием
дополнительных модулей;
<LI>C2Ptest - конверсия chunky-planar с комплексной арифметикой;
<LI>Demoeffect  -  эффект  мыльных пузырей на CGX экране в 320x240 с показом
расчётной структуры;
<LI>Voxelspace  -  Voxel  демонстрационный пример от Haage&Partner с показом
структуры при установленном "t" параметре и экране 320x240x8;
<LI>LZX - сжатие в lzx, используя параметр "-3".</UL>
При тестировании использовались следующие конфигурации Амиг:<UL>
<LI>A1200+BlizzardPPC 603e/160, 040LC/25, Mediator+Voodoo3+Picasso96,
<LI>A1200+BlizzardPPC 603e/210, 040/25, BlizzardVision+CGX,
<LI>A4000+WarpEngine 040/40, CyberVision64+Picasso96,
<LI>A4000+CyberstormPPC 604e/233, 060/50, PicassoIV+Picasso96.</UL>
Эталонные тесты взяты с Chip/Kangoroo, Sau, Ph03n1x.<BR><BR>
А  теперь  пара  FAQ  по  проекту Petunia с использованием форума по данной
теме:<BR><BR>
<FONT COLOR="yellow">Когда будет готова полноценная эмуляция?</FONT><BR>
Технически  эмуляция  готова.   Теперь мы воздействуем на интеграцию самого
ядра.   Это  очень  длительный  процесс,  пока  всё  идёт так, как  было
запланировано, так что ждите выхода AmigaOS4.<BR><BR>
<FONT COLOR="yellow">Почему  номер  версии столь низок?  И будет ли версия 1.0 неким законченным
этапом?</FONT><BR>
Если   честно,  то  номер  версии  ничего  не  показывает.   Это  -  только
беллетристика  автора.   Мы  могли  написать  и  1.5,  но  что  от этого бы
изменилось?   А  к выходу версии 1.0 будет реализована полноценная эмуляция
68040.<BR><BR>
<FONT COLOR="yellow">Какой процессор реализован на данный момент?</FONT><BR>
Motorola 68040 с FPU, без MMU.<BR><BR>
<FONT COLOR="yellow">Когда будет работать FPU?</FONT><BR>
Фактически  оно  уже  работает, но как всегда скопилось куча ошибок, которые
надо исправить.<BR><BR>
<FONT COLOR="yellow">Каким   образом   реализована   эмуляция   68881/882   FPU?  Потребуется ли
программа эмуляции, например, Oxypatcher?</FONT><BR>
Нет, это было бы ерундой. Эмуляция реализована самой Petunia, что позволяет
избежать использования 68040.library или Oxypatcher.<BR><BR>
<FONT COLOR="yellow">Насколько же быстро будет реализована эмуляция в AmigaOS4?</FONT><BR>
Фактически никто этого не знает.  Так что не верьте никому, кто говорит вам
про  скорость эмуляции 680x0 в OS4.  В одном я уверен точно, будет работать
не меньше уровня M68060/50Mhz на PPC604/233, из этого и стоит исходить.  Но
также   не  стоит  забывать,  что  со  временем  все  программные  продукты
перекочуют под код PPC.<BR><BR>
<FONT COLOR="yellow">А будут ли работать AGA-игры и демы?</FONT><BR>
Скажу  правду,  я  делаю  только  эмуляцию  процессора,  а  не полноценного
чипсета.   В  следствие  этого  80-90%  программ  будут работать, ну а за
остальные я не ручаюсь, хотя под UAE будет доступно всё.<BR><BR>
<FONT COLOR="yellow">А планируется ли поддержка UAE?</FONT><BR>
Пока  нет.   Теоретически  такое возможно, но в будущем; тогда возможно
выйдет  специальная  версия Petunia под UAE.  Ну а вообще, Petunia не имеет
никакого отношения к JIT-версии UAE под интеловские процессоры.  И поэтому
версии  Petunia под  их процессоры не будет, скорее я оставляю компьютерный
мир вообще, чем переключусь на ПЦ-платформу.<BR><BR>
<FONT COLOR="yellow">Как работает эмуляция?</FONT><BR>
Есть  три  метода  подхода к эмуляции:  полная эмуляция машины для работы с
нативным  кодом (по такому методу работает UAE); виртуальный, так называемый
Amiga-in-the-box,  например,  Java и MacOnLinux, позволяющий запускать MacOS-X
на  Амиге;  и  третий, базовая эмуляция, когда эмулируется свой собственный
процесс  зависимо от других.  Эмуляция в AmigaOS4 будет работать как раз по
данному последнему методу, за исключением того, что там будет MMU-кодек под
680x0,   таким  образом  и  увеличится  скорость  переключения,  понизится
требуемая   конфигурация,   затраты   к  памяти,  и  упростится  механизм
преобразования.   Вы спросите, почему именно третий метод? Всё очень просто,
отпадает  потребность  в  виртуализации  ресурсов,  не требуется построения
сложного   механизма   эмуляции,   каждая   задача  имеет  свою  собственную
интерпретацию,  что  существенно  увеличивает скорость.  Остальная же часть
системы  работает  на  полную  скорость,  потому  что эмулятор представляет
простой кодек, где каждая задача выполняется индивидуально.<BR><BR>
<FONT COLOR="yellow">Что относительно будущего PPC процессоров?</FONT><BR>
Платформа  PowerPC - хорошо запланирована, что в будущем не вызовет никаких
проблем  с переходом на 64-битные процессоры.  Petunia будет работать и на
PowerPC  64-bit,  конечно  это  потребует некоторого усовершенствования, но
данный  факт  не  столь  существенный.   А  переход  Petunia на  другой тип
процессора  полностью  бессмысленный,  так как проект заточен под PowerPC и
привязан к Амижной архитектуре.<BR><BR>
<FONT COLOR="yellow">А поддерживает ли Petunia AltiVec PPC G4?</FONT><BR>
Если  честно,  то  я  не  вижу  реальной  потребности в AltiVec, потому что
эмуляция  не  требует  частых  вычислений, программа перекомпилируется один
раз,  а потом просто хранится в памяти.  А вообще, я естественно буду иметь
ввиду AltiVec SIMD кодек, возможно со временем мы и его подключим.<BR><BR>
<FONT COLOR="yellow">Как относительно мультипроцессорности?</FONT><BR>
Вообще  не  проблема.   Из-за того, что каждая эмуляция представлена в виде
отдельной    задачи,    операционная   система   сама   переводит   её   на
мультипроцессорность,  то есть  если один процессор занят, то осуществляется
переход на второй, а если оба свободны, то и работают оба.  Что невозможно
при втором, виртуальном, методе эмулирования, вот и ещё один плюс Petunia.<BR><BR>
<FONT COLOR="yellow">Каково ваше мнение о AmigaOS4?</FONT><BR>
Это  просто  киллер.   Помните  изменения при перехода от AOS1.3 к AOS2.0?
Скачёк от OS3.9 к OS4 будет намного больше, нет просто огромнейший!<BR><BR>
<FONT COLOR="yellow">Вы планируете сотрудничать с командой MorphOS?</FONT><BR>
К  сожалению  нет.   MorphOS  имеет собственный прекраснейший интерпретатор
кода 680x0, так что в каком-то смысле я даже им завидую, но по-доброму.
</b></FONT>
</td></tr>
</table>
</td>
</tr>
</table><br>

</CENTER>
</BODY>
</HTML>