<!!!!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<html>

	<head>
		<meta http-equiv="content-type" content="text/html;charset=iso-8859-1">
		<title>Sekalaiset</title>
		<meta name="generator" content="Handmade in Finland">
	</head>

	<body bgcolor="white" link="navy" vlink="navy" alink="red" leftmargin="0" marginheight="0" marginwidth="0" topmargin="0">
		<center>
			<a name="top"></a>
			<table border="0" cellspacing="0" cellpadding="12">
				<tr>
					<td><img src="../../framet/grafiikka/bullet.gif" alt="" height="8" width="8" border="0" hspace="6"><font size="2" face="Trebuchet MS,Verdana,Arial,Helvetica"><a href="hakemisto.html" target="_self">Sekalaiset</a></font>&nbsp;&nbsp;&nbsp;<img src="../../framet/grafiikka/bullet.gif" alt="" height="8" width="8" border="0" hspace="6"><font size="2" face="Trebuchet MS,Verdana,Arial,Helvetica"><a href="../sivukartta.html" target="_self">Sivukartta</a></font></td>
				</tr>
			</table>
			<table width="80%" border="0" cellspacing="1" cellpadding="4" bgcolor="navy">
				<tr>
					<td align="center" bgcolor="navy" width="100%"><font size="3" color="yellow" face="Arial,Helvetica,Geneva,Swiss,SunSans-Regular"><b>MorphOS-ohjelmointia</b></font></td>
				</tr>
				<tr height="15">
					<td align="center" bgcolor="#d8ecfd" width="100%" height="15"><font size="2" color="#000066" face="Arial,Helvetica,Geneva,Swiss,SunSans-Regular">Ilkka Lehtoranta &lt;<a href="mailto:ilkleht@isoveli.org">ilkleht@isoveli.org</a>&gt;</font></td>
				</tr>
			</table>
			<font size="1" face="Trebuchet MS,Verdana,Arial,Helvetica"><br>
			</font>
			<table width="80%" border="0" cellspacing="1" cellpadding="3" bgcolor="navy">
				<tr>
					<td bgcolor="#d8ecfd" width="50%">
						<p><font size="2" face="Trebuchet MS,Verdana,Arial,Helvetica"><b>MorphOS tuo ohjelmoijalle uutta p&auml;&auml;nvaivaa. Uusi uljas PPC-k&auml;ytt&ouml;j&auml;rjestelm&auml; tuo tehoa ohjelmointiin, mutta kaikki ei olekaan en&auml;&auml; niin kuin ennen. Vanhojen 68k-ohjelmien t&auml;ytyy py&ouml;ri&auml; sulassa sovussa uusien PPC-ohjelmien kanssa. Jotta yhteiselo ei p&auml;&auml;ttyisi katastrofiin, t&auml;ytyy PPC-ohjelmoijan antaa tilaa my&ouml;s vanhalle 68k-kumppanille. Seuraavassa katsotaan l&auml;&auml;kkeit&auml; onnelliseen yhteiseloon ja vilkaistaan lopuksi, mit&auml; uutta MorphOS on tuonut tullessaan.</b></font></p>
					</td>
				</tr>
			</table>
			<br>
			<table width="80%" border="0" cellspacing="1" cellpadding="3" bgcolor="navy">
				<tr>
					<td bgcolor="#d8ecfd" width="50%">
						<p><font size="2" face="Trebuchet MS,Verdana,Arial,Helvetica">Yleens&auml; koukkujen (ns. callback hook) k&auml;ytt&ouml; on varsin helppoa: varataan struktuurille muistia ja alustetaan se osoittamaan kutsuttavaan funktioon. Vanhassa 68k-pohjaisessa AmigaOS:ssa oli vain yksi konekieli eik&auml; PPC-koodin kutsumista koukun takaa tuettu. MorphOS:ssa taas koukku voi johtaa kumpaakin eli se voi osoittaa niin 68k- kuin PPC-koodiinkin. Mutta miten saada koukku toimimaan niin ett&auml; vanhakin siit&auml; tajuaa? Ratkaisuna on trappaaminen ja pieni vaivann&auml;k&ouml; ohjelmoijalta.<br>
								<br>
								MorphOS laajentaa 68k:n k&auml;skykantaa $F-alkuisilla konekielik&auml;skyill&auml;. Normaalisti 68k antaisi siit&auml; virheen, mutta MorphOS:n 68k-emulaattorille se on merkki alkavasta PPC-koodista. Oikeasti se on EmulLibEntry -struktuurin alku, josta l&ouml;ytyy osoitin varsinaiseen PPC-koodiin:</font></p>
						<pre>
struct EmulLibEntry
{
   UWORD    Trap;          /* kutsumetodi */
   UWORD    Extension;     /* t&auml;ytyy olla nolla */
   void     (*Func)(void); /* itse funktio */
};
</pre>
						<p><font size="2" face="Trebuchet MS,Verdana,Arial,Helvetica">Kun natiivi PPC-ohjelma kutsuu tuntematonta koukkua, oletuksena t&auml;ytyy aina olla, ett&auml; koukun takaa l&ouml;ytyy 68k-koodia. Natiivi PPC-ohjelma ei saa koskaan kutsua tuntemattomia funktio-osoittimia k&auml;sin. Aina t&auml;ytyy k&auml;ytt&auml;&auml; CallHookPkt()-kutsua tai vastaavaa k&auml;ytt&ouml;j&auml;rjestelm&auml;n metodia. Erityisen kielletty&auml; on yritt&auml;&auml; itse kutsua EmulLibEntryss&auml; olevaa funktiota.</font></p>
					</td>
				</tr>
			</table>
			<font size="1" face="Trebuchet MS,Verdana,Arial,Helvetica"><br>
			</font>
			<table width="80%" border="0" cellspacing="1" cellpadding="3" bgcolor="navy">
				<tr valign="middle">
					<td align="center" bgcolor="#b0c4de" width="50%">
						<table border="0" cellspacing="0" cellpadding="0" align="right" height="20">
							<tr>
								<td><a title="Alkuun" href="#top" target="_self"><img src="../../framet/grafiikka/top.gif" alt="alkuun" height="14" width="15" border="0"></a></td>
							</tr>
						</table>
						<b><font size="3" face="Trebuchet MS,Verdana,Arial,Helvetica">Hookin rakentaminen</font></b></td>
				</tr>
				<tr>
					<td bgcolor="#d8ecfd" width="50%">
						<p><font size="2" face="Trebuchet MS,Verdana,Arial,Helvetica">Toimivan PPC-hookin rakentaminen on kuitenkin varsin yksinkertaista. Hook struktuurin h_Entryn t&auml;ytyy osoittaa EmulLibEntryyn. EmulLibEntryn kentt&auml; Trap sis&auml;lt&auml;&auml; halutun kutsumetodin (yleens&auml; TRAP_LIB), Extension nollataan ja Func sitten sis&auml;lt&auml;&auml; todellisen osoitteen. Koska n&auml;m&auml; kaksi struktuuria toimivat yhteisty&ouml;ss&auml; kannattaa ne yhdist&auml;&auml;:</font></p>
						<pre>
struct EmulLibEntry
{
   UWORD    Trap;          /* kutsumetodi */
   UWORD    Extension;     /* t&auml;ytyy olla nolla */
   void     (*Func)(void); /* itse funktio */
};
</pre>
						<p><font size="2" face="Trebuchet MS,Verdana,Arial,Helvetica">Toimiva koukku voitaisiin nyt m&auml;&auml;ritell&auml; seuraavasti:</font></p>
						<pre>
struct EmulHook Koukku =
{
   NULL,
   NULL,
   (HOOKFUNC)&Koukku.emul,
   NULL,
   NULL,
   TRAP_LIB,
   0,
   (void *)(OhjelmaKoodi)
};
</pre>
						<p><font size="2" face="Trebuchet MS,Verdana,Arial,Helvetica">Assemblerilla koukku n&auml;ytt&auml;isi seuraavalta:</font></p>
						<pre>
Koukku:
   .long 0
   .long 0
   .long Koukku+20
   .long 0
   .long 0
   .short 65280
   .short 0
   .long OhjelmaKoodi
</pre>
						<p><font size="2" face="Trebuchet MS,Verdana,Arial,Helvetica">Huomaa, ett&auml; EmulLibEntry&auml; voi joutua k&auml;ytt&auml;m&auml;&auml;n my&ouml;s muissa yhteyksiss&auml; kuin koukuissa. Se on siis yleisty&ouml;kalu, joka kelpaa muuhunkin kuin koukkujen rakentamiseen.</font></p>
					</td>
				</tr>
			</table>
			<br>
			<table width="80%" border="0" cellspacing="1" cellpadding="3" bgcolor="navy">
				<tr valign="middle">
					<td align="center" bgcolor="#b0c4de" width="50%">
						<table border="0" cellspacing="0" cellpadding="0" align="right" height="20">
							<tr>
								<td><a title="Alkuun" href="#top" target="_self"><img src="../../framet/grafiikka/top.gif" alt="alkuun" height="14" width="15" border="0"></a></td>
							</tr>
						</table>
						<b><font size="3" face="Trebuchet MS,Verdana,Arial,Helvetica">68k-parametrien lukeminen</font></b></td>
				</tr>
				<tr>
					<td bgcolor="#d8ecfd" width="50%">
						<p><font size="2" face="Trebuchet MS,Verdana,Arial,Helvetica">Ennen kuin toimiva koukku saadaan rakennettua, meille j&auml;&auml; viel&auml; yksi ongelma. Koukkujenhan mukana v&auml;litet&auml;&auml;n mit&auml; moninaisimpia parametreja 68k:n rekistereiss&auml;. Esimerkiksi CallHookPkt() j&auml;tt&auml;&auml; rekistereihin A0/A2/A1 arvoja, joita kutsuttava ohjelman p&auml;tk&auml; voi k&auml;ytt&auml;&auml; hy&ouml;dykseen. PPC:ss&auml; n&auml;it&auml; rekistereit&auml; ei tietenk&auml;&auml;n ole, joten arvot on l&ouml;ydett&auml;v&auml; jostain muualta. Jokaisella ohjelmalla rekisteri r2 osoittaa struktuuriin EmulHandle:</font></p>
						<pre>
struct   EmulHandle
{
   ULONG       Dn[8];
   ULONG       An[8];
   ULONG       *PC;
   ULONG       SR;

   /* + paljon muuta... */
};
</pre>
						<p><font size="2" face="Trebuchet MS,Verdana,Arial,Helvetica">Yll&auml; olevasta struktuurista l&ouml;ytyv&auml;t talletettuna kaikki 68k:n rekisterit, joita saa lukea vapaasti. Dn[] sis&auml;lt&auml;&auml; datarekisterit ja An[] puolestaan osoiterekisterit. EmulHandlen lukeminen on kuitenkin ty&ouml;l&auml;st&auml;, joten Harry Sintonen on kirjoittanut avuksi <a http"declgate.h" href="declgate.h">makrot</a> parametreille. Samalla my&ouml;s ohjelman siirrett&auml;vyys eri alustoille (OS3, OS4 ja MorphOS) paranee:</font></p>
						<pre>
struct Library *NATDECLFUNC_1(LibOpen, a6, struct Library *, mybase)
{
   DECLARG_1(a6, struct Library *, mybase)

   mybase-&gt;lib_Flags &amp;= ~LIBF_DELEXP;
   mybase-&gt;lib_OpenCnt++;
   return(mybase);
}
</pre>
						<p><font size="2" face="Trebuchet MS,Verdana,Arial,Helvetica">Riippumatta siit&auml;, mille alustalle k&auml;&auml;nt&auml;&auml;, ovat parametrit aina oikein.</font></p>
					</td>
				</tr>
			</table>
			<br>
			<table width="80%" border="0" cellspacing="1" cellpadding="3" bgcolor="navy">
				<tr valign="middle">
					<td align="center" bgcolor="#b0c4de" width="50%">
						<table border="0" cellspacing="0" cellpadding="0" align="right" height="20">
							<tr>
								<td><a title="Alkuun" href="#top" target="_self"><img src="../../framet/grafiikka/top.gif" alt="alkuun" height="14" width="15" border="0"></a></td>
							</tr>
						</table>
						<b><font size="3" face="Trebuchet MS,Verdana,Arial,Helvetica">Lopuksi flushataan</font></b></td>
				</tr>
				<tr>
					<td bgcolor="#d8ecfd" width="50%"><font size="2" face="Trebuchet MS,Verdana,Arial,Helvetica">MorphOS:n exec.library sis&auml;lt&auml;&auml; paitsi kaikki OS 3.1:n funktiot, my&ouml;s joukon uusia. Perinteinen AllocPooled() on saanut rinnalleen AllocVecPooled()-kutsun, joka vastaa vanhaa AllocVec()-kutsua mutta toimii muistipoolien kanssa. Aivan uutta on ohjelmakohtainen muistipooli, jonka k&auml;ytt&ouml;j&auml;rjestelm&auml; tuhoaa automaattisesti ohjelman suorituksen loputtua. Poolista voi varata muistia AllocTaskPooled()- ja AllocVecTaskPooled()-kutsuilla ja vastaavasti vapauttaa FreeTaskPooled()- ja FreeVecTaskPooled()- kutsuilla. Sokerina pohjalla on FlushPool(), jolla muistipoolin voi tyhjent&auml;&auml; tuhoamatta sit&auml;. Oheisessa taulukossa on koottuna uudet funktiot ja niiden parametrimallit. MorphOS:sta l&ouml;ytyy my&ouml;s muita uusia funktioita, joten protoja kannattaa lukea ahkerasti. Eih&auml;n sit&auml; koskaan tied&auml;...<br>
							<br>
							<table border="0" cellspacing="2" cellpadding="3">
								<tr>
									<td bgcolor="#336699"><font size="2" color="white" face="Arial,Helvetica,Geneva,Swiss,SunSans-Regular"><b>Funktio</b></font></td>
									<td bgcolor="#336699"><font size="2" color="white" face="Arial,Helvetica,Geneva,Swiss,SunSans-Regular"><b>Parametrit</b></font></td>
								</tr>
								<tr>
  <td bgcolor="#b0c4de"><font size="2" color="black" face="Arial,Helvetica,Geneva,Swiss,SunSans-Regular">AllocTaskPooled</font></td>
  <td bgcolor="#b0c4de"><font size="2" face="Arial,Helvetica,Geneva,Swiss,SunSans-Regular">(ULONG Size)</font></td>
</tr>

<tr>
  <td bgcolor="#b0c4de"><font size="2" color="black" face="Arial,Helvetica,Geneva,Swiss,SunSans-Regular">AllocVecPooled</font></td>
  <td bgcolor="#b0c4de"><font size="2" face="Arial,Helvetica,Geneva,Swiss,SunSans-Regular">(APTR poolHeader, ULONG Size)</font></td>
</tr>

<tr>
  <td bgcolor="#b0c4de"><font size="2" color="black" face="Arial,Helvetica,Geneva,Swiss,SunSans-Regular">AllocVecTaskPooled</font></td>
  <td bgcolor="#b0c4de"><font size="2" face="Arial,Helvetica,Geneva,Swiss,SunSans-Regular">(ULONG Size)</font></td>
</tr>

<tr>
  <td bgcolor="#b0c4de"><font size="2" color="black" face="Arial,Helvetica,Geneva,Swiss,SunSans-Regular">FreeTaskPooled</font></td>
  <td bgcolor="#b0c4de"><font size="2" face="Arial,Helvetica,Geneva,Swiss,SunSans-Regular">(APTR Address, ULONG Size)</font></td>
</tr>

<tr>
  <td bgcolor="#b0c4de"><font size="2" color="black" face="Arial,Helvetica,Geneva,Swiss,SunSans-Regular">FreeVecPooled</font></td>
  <td bgcolor="#b0c4de"><font size="2" face="Arial,Helvetica,Geneva,Swiss,SunSans-Regular">(APTR poolHeader, APTR memory)</font></td>
</tr>

<tr>
  <td bgcolor="#b0c4de"><font size="2" color="black" face="Arial,Helvetica,Geneva,Swiss,SunSans-Regular">FreeVecTaskPooled</font></td>
  <td bgcolor="#b0c4de"><font size="2" face="Arial,Helvetica,Geneva,Swiss,SunSans-Regular">(APTR memory)</font></td>
</tr>

<tr>
  <td bgcolor="#b0c4de"><font size="2" color="black" face="Arial,Helvetica,Geneva,Swiss,SunSans-Regular">FlushPool</font></td>
  <td bgcolor="#b0c4de"><font size="2" face="Arial,Helvetica,Geneva,Swiss,SunSans-Regular">(APTR poolHeader)</font></td>
</tr>

</table>
							<br>
							
							

Tarvittavat tiedostot ja lyhyt esimerkkikoodi <a href="Esimerkkikoodi.lha">pakettina.
</font></td>
				</tr>
			</table>
			<table border="0" cellspacing="0" cellpadding="12">
				<tr>
					<td><img src="../../framet/grafiikka/bullet.gif" alt="" height="8" width="8" border="0" hspace="6"><font size="2" face="Trebuchet MS,Verdana,Arial,Helvetica"><a href="hakemisto.html" target="_self">Sekalaiset</a></font>&nbsp;&nbsp;&nbsp;<img src="../../framet/grafiikka/bullet.gif" alt="" height="8" width="8" border="0" hspace="6"><font size="2" face="Trebuchet MS,Verdana,Arial,Helvetica"><a href="#top" target="_self">Sivun alkuun</a>&nbsp;&nbsp;&nbsp;</font><img src="../../framet/grafiikka/bullet.gif" alt="" height="8" width="8" border="0" hspace="6"><font size="2" face="Trebuchet MS,Verdana,Arial,Helvetica"><a href="../sivukartta.html" target="_self">Sivukartta</a></font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
				</tr>
			</table>
		</center>
	</body>

</html>